angular.module("ui.rCalendar",[]).constant("calendarConfig",{formatDay:"dd",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, Week w",formatMonthTitle:"MMMM yyyy",formatWeekViewDayHeader:"EEE d",formatHourColumn:"ha",calendarMode:"month",showEventDetail:!0,startingDayMonth:0,startingDayWeek:0,allDayLabel:"all day",noEventsLabel:"No Events",eventSource:null,queryMode:"local",step:60,disableAllDay:!1,dayStart:0,dayEnd:24,disableSwipe:!1,monthviewDisplayEventTemplateUrl:"templates/rcalendar/monthviewDisplayEvent.html",monthviewEventDetailTemplateUrl:"templates/rcalendar/monthviewEventDetail.html",weekviewAllDayEventTemplateUrl:"templates/rcalendar/displayEvent.html",weekviewNormalEventTemplateUrl:"templates/rcalendar/displayEvent.html",dayviewAllDayEventTemplateUrl:"templates/rcalendar/displayEvent.html",dayviewNormalEventTemplateUrl:"templates/rcalendar/displayEvent.html"}).controller("ui.rCalendar.CalendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","calendarConfig","$timeout","$ionicSlideBoxDelegate",function(a,b,c,d,e,f,g,h,i){"use strict";function j(a,b){var c=a,d=b;return(a.startIndex>b.startIndex||a.startIndex===b.startIndex&&a.startOffset>b.startOffset)&&(c=b,d=a),!(c.endIndex<=d.startIndex)&&!(c.endIndex-d.startIndex===1&&c.endOffset+d.startOffset>n.hourParts)}function k(a){var b,c,d,e=a.length,f=0,g=new Array(e);for(b=0;b<e;b+=1){for(d=0;d<f;d+=1)g[d]=!1;for(c=0;c<b;c+=1)j(a[b],a[c])&&(g[a[c].position]=!0);for(d=0;d<f&&g[d];d+=1);d<f?a[b].position=d:a[b].position=f++}}function l(a){var b,c,d,e,f,g,h,i=new Array(24);for(a.sort(function(a,b){return b.position-a.position}),d=0;d<24;d+=1)i[d]={calculated:!1,events:[]};for(f=a.length,d=0;d<f;d+=1)for(b=a[d],c=b.startIndex;c<b.endIndex;)i[c].events.push(b),c+=1;for(d=0;d<f;){if(b=a[d],!b.overlapNumber){var j=b.position+1;b.overlapNumber=j;for(var k=[b];b=k.shift();)for(c=b.startIndex;c<b.endIndex;){if(!i[c].calculated&&(i[c].calculated=!0,i[c].events))for(g=i[c].events.length,e=0;e<g;e+=1)h=i[c].events[e],h.overlapNumber||(h.overlapNumber=j,k.push(h));c+=1}}d+=1}}function m(b,c){var d,e=n.mode.step,f=new Date(b),g=f.getFullYear()+c*(e.years||0),h=f.getMonth()+c*(e.months||0),i=f.getDate()+c*(e.days||0);return f.setFullYear(g,h,i),"month"===a.calendarMode&&(d=new Date(g,h+1,1),d.getTime()<=f.getTime()&&(f=new Date(d-864e5))),f}var n=this,o={$setViewValue:angular.noop};if(angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","formatWeekViewDayHeader","formatHourColumn","allDayLabel","noEventsLabel","disableAllDay","dayStart","dayEnd","disableSwipe"],function(c,e){n[c]=angular.isDefined(b[c])?d(b[c])(a.$parent):g[c]}),angular.forEach(["showEventDetail","monthviewDisplayEventTemplateUrl","monthviewEventDetailTemplateUrl","weekviewAllDayEventTemplateUrl","weekviewNormalEventTemplateUrl","dayviewAllDayEventTemplateUrl","dayviewNormalEventTemplateUrl","eventSource","queryMode","step","startingDayMonth","startingDayWeek"],function(c,d){n[c]=angular.isDefined(b[c])?a.$parent.$eval(b[c]):g[c]}),a.disableAllDay=g.disableAllDay,a.dayStart=g.dayStart,a.dayEnd=g.dayEnd,a.disableSwipe=g.disableSwipe,n.hourParts=1,60!==n.step&&30!==n.step&&15!==n.step)throw new Error("Invalid step parameter: "+n.step);n.hourParts=Math.floor(60/n.step),a.$parent.$watch(b.eventSource,function(a){n.onEventSourceChanged(a)}),a.calendarMode=a.calendarMode||g.calendarMode,angular.isDefined(b.initDate)&&(n.currentCalendarDate=a.$parent.$eval(b.initDate)),n.currentCalendarDate||(n.currentCalendarDate=new Date,b.ngModel&&!a.$parent.$eval(b.ngModel)&&c(b.ngModel).assign(a.$parent,n.currentCalendarDate)),n.init=function(a){o=a,o.$render=function(){n.render()}},n.render=function(){if(o.$modelValue){var a=new Date(o.$modelValue),b=!isNaN(a);b?this.currentCalendarDate=a:e.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),o.$setValidity("date",b)}this.refreshView()},n.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),a.titleChanged&&a.titleChanged({title:n._getTitle()}),this._refreshView(),this.rangeChanged())},n.split=function(a,b){for(var c=[];a.length>0;)c.push(a.splice(0,b));return c},n.onEventSourceChanged=function(a){n.eventSource=a,n._onDataLoaded&&n._onDataLoaded()},n.getAdjacentViewStartTime=function(a){var b=m(n.currentCalendarDate,a);return n._getRange(b).startTime},n.move=function(a){n.direction=a,n.moveOnSelected?n.moveOnSelected=!1:n.currentCalendarDate=m(n.currentCalendarDate,a),o.$setViewValue(n.currentCalendarDate),n.refreshView(),n.direction=0},n.rangeChanged=function(){"local"===n.queryMode?n.eventSource&&n._onDataLoaded&&n._onDataLoaded():"remote"===n.queryMode&&a.rangeChanged&&a.rangeChanged({startTime:this.range.startTime,endTime:this.range.endTime})},n.registerSlideChanged=function(a){a.currentViewIndex=0,a.slideChanged=function(b){h(function(){var c=a.currentViewIndex,d=0;b-c===1||0===b&&2===c?d=1:(c-b===1||2===b&&0===c)&&(d=-1),c=b,a.currentViewIndex=c,n.move(d),a.$digest()},200)}},n.populateAdjacentViews=function(a){var b,c,d,e=a.currentViewIndex,f=this._getViewData;1===n.direction?(b=n.getAdjacentViewStartTime(1),d=(e+1)%3,angular.copy(f(b),a.views[d])):n.direction===-1?(b=n.getAdjacentViewStartTime(-1),d=(e+2)%3,angular.copy(f(b),a.views[d])):a.views?(b=n.range.startTime,angular.copy(f(b),a.views[e]),b=n.getAdjacentViewStartTime(-1),d=(e+2)%3,angular.copy(f(b),a.views[d]),b=n.getAdjacentViewStartTime(1),d=(e+1)%3,angular.copy(f(b),a.views[d])):(c=[],b=n.range.startTime,c.push(f(b)),b=n.getAdjacentViewStartTime(1),c.push(f(b)),b=n.getAdjacentViewStartTime(-1),c.push(f(b)),a.views=c)},n.placeEvents=function(a){k(a),l(a)},n.placeAllDayEvents=function(a){k(a)},n.slideView=function(b){var c=i.$getByHandle(a.calendarMode+"view-slide");c&&(1===b?c.next():b===-1&&c.previous())}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/calendar.html",scope:{calendarMode:"=",rangeChanged:"&",eventSelected:"=",timeSelected:"=",titleChanged:"&"},require:["calendar","?^ngModel"],controller:"ui.rCalendar.CalendarController",link:function(a,b,c,d){var e=d[0],f=d[1];f&&e.init(f),a.$on("changeDate",function(a,b){e.slideView(b)}),a.$on("eventSourceChanged",function(a,b){e.onEventSourceChanged(b)})}}}).directive("monthview",["dateFilter","$ionicSlideBoxDelegate",function(a,b){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/month.html",require:["^calendar","?^ngModel"],link:function(c,d,e,f){function g(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);e<b;)c[e++]=new Date(d),d.setDate(d.getDate()+1);return c}function h(b,c){return{date:b,label:a(b,c)}}function i(a,b){var d,e=k.currentCalendarDate,f=new Date,g=864e5,h=Math.floor((e.getTime()-a.getTime())/g),i=Math.floor((f.getTime()-a.getTime())/g);for(d=0;d<42;d+=1)b.dates[d].selected=!1;h>=0&&h<42?(b.dates[h].selected=!0,c.selectedDate=b.dates[h]):c.selectedDate={events:[]},i>=0&&i<42&&(b.dates[i].current=!0)}function j(a,b){return a.allDay?1:b.allDay?-1:a.startTime.getTime()-b.startTime.getTime()}var k=f[0],l=f[1];c.showEventDetail=k.showEventDetail,c.formatDayHeader=k.formatDayHeader,k.disableSwipe&&b.enableSlide(!1),k.mode={step:{months:1}},c.noEventsLabel=k.noEventsLabel,c.displayEventTemplateUrl=k.monthviewDisplayEventTemplateUrl,c.eventDetailTemplateUrl=k.monthviewEventDetailTemplateUrl,c.select=function(a,b){var d,e,f=c.views;if(f){d=f[c.currentViewIndex].dates;var g=k.currentCalendarDate,h=g.getMonth(),i=g.getFullYear(),j=a.getMonth(),m=a.getFullYear(),n=0;if(i===m?h!==j&&(n=h<j?1:-1):n=i<m?1:-1,k.currentCalendarDate=a,0===n){k.currentCalendarDate=a,l&&l.$setViewValue(a);var o=k.range.startTime,p=864e5,q=Math.floor((a.getTime()-o.getTime())/p);for(e=0;e<42;e+=1)d[e].selected=!1;q>=0&&q<42&&(d[q].selected=!0,c.selectedDate=d[q])}else k.moveOnSelected=!0,k.slideView(n);c.timeSelected&&c.timeSelected({selectedTime:a,events:b})}},c.getHighlightClass=function(a){var b="";return a.hasEvent&&(b=a.secondary?"monthview-secondary-with-event":"monthview-primary-with-event"),a.selected&&(b&&(b+=" "),b+="monthview-selected"),a.current&&(b&&(b+=" "),b+="monthview-current"),a.secondary&&(b&&(b+=" "),b+="text-muted"),b},k._getTitle=function(){var b=k.range.startTime,c=b.getDate(),d=(b.getMonth()+(1!==c?1:0))%12,e=b.getFullYear()+(1!==c&&0===d?1:0),f=new Date(e,d,1);return a(f,k.formatMonthTitle)},k._getViewData=function(a){for(var b=a,c=b.getDate(),d=(b.getMonth()+(1!==c?1:0))%12,e=g(b,42),f=0;f<42;f++)e[f]=angular.extend(h(e[f],k.formatDay),{secondary:e[f].getMonth()!==d});return{dates:e}},k._refreshView=function(){k.populateAdjacentViews(c),i(k.range.startTime,c.views[c.currentViewIndex])},k._onDataLoaded=function(){for(var a=k.eventSource,b=a?a.length:0,d=k.range.startTime,e=k.range.endTime,f=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())),g=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),h=c.currentViewIndex,i=c.views[h].dates,l=864e5,m=.001,n=0;n<42;n+=1)i[n].hasEvent&&(i[n].hasEvent=!1,i[n].events=[]);for(var o=0;o<b;o+=1){var p,q,r=a[o],s=new Date(r.startTime),t=new Date(r.endTime);if(r.allDay){if(t<=f||s>=g)continue;p=f,q=g}else{if(t<=d||s>=e)continue;p=d,q=e}var u,v;s<=p?v=0:(u=s-p,r.allDay||(u-=6e4*(s.getTimezoneOffset()-p.getTimezoneOffset())),v=u/l);var w;t>=q?(u=q-p,r.allDay||(u-=6e4*(q.getTimezoneOffset()-p.getTimezoneOffset())),w=u/l):(u=t-p,r.allDay||(u-=6e4*(t.getTimezoneOffset()-p.getTimezoneOffset())),w=u/l);for(var x,y=Math.floor(v);y<w-m;)i[y].hasEvent=!0,x=i[y].events,x?x.push(r):(x=[],x.push(r),i[y].events=x),y+=1}for(n=0;n<42;n+=1)i[n].hasEvent&&i[n].events.sort(j);var z=!1;for(n=0;n<42;n+=1){if(i[n].selected){c.selectedDate=i[n],z=!0;break}if(z)break}},k._getRange=function(a){var b,c=a.getFullYear(),d=a.getMonth(),e=new Date(c,d,1),f=k.startingDayMonth-e.getDay(),g=f>0?7-f:-f,h=new Date(e);return g>0&&h.setDate(-g+1),b=new Date(h),b.setDate(b.getDate()+42),{startTime:h,endTime:b}},k.registerSlideChanged(c),k.refreshView()}}}]).directive("weekview",["dateFilter","$ionicSlideBoxDelegate",function(a,b){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/week.html",require:"^calendar",link:function(c,d,e,f){function g(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);e<b;)c[e++]={date:new Date(d)},d.setDate(d.getDate()+1);return c}function h(a){for(var b,c,d=[],e=a.getHours(),f=a.getDate(),g=0;g<24;g+=1){b=[];for(var h=0;h<7;h+=1)c=new Date(a.getTime()),c.setHours(e+g),c.setDate(f+h),b.push({time:c});d.push(b)}return d}function i(a,b){return a.startOffset-b.startOffset}function j(a){var b=new Date(a);b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1}f.disableSwipe&&b.enableSlide(!1),c.formatWeekViewDayHeader=f.formatWeekViewDayHeader,c.formatHourColumn=f.formatHourColumn,f.mode={step:{days:7}},c.allDayLabel=f.allDayLabel,c.hourParts=f.hourParts,c.allDayEventTemplateUrl=f.weekviewAllDayEventTemplateUrl,c.normalEventTemplateUrl=f.weekviewNormalEventTemplateUrl,c.dayStart=f.dayStart,c.dayEnd=f.dayEnd,f._getTitle=function(){var b,c,d=f.range.startTime,e="w";return b=f.formatWeekTitle.indexOf(e),c=a(d,f.formatWeekTitle),b!==-1&&(c=c.replace(e,j(d))),c},c.select=function(a,b){c.timeSelected&&c.timeSelected({selectedTime:a,events:b})},f._getViewData=function(a){return{rows:h(a),dates:g(a,7)}},f._refreshView=function(){f.populateAdjacentViews(c)},f._onDataLoaded=function(){var a,b,d,e,g=f.eventSource,h=g?g.length:0,j=f.range.startTime,k=f.range.endTime,l=new Date(Date.UTC(j.getFullYear(),j.getMonth(),j.getDate())),m=new Date(Date.UTC(k.getFullYear(),k.getMonth(),k.getDate())),n=c.currentViewIndex,o=c.views[n].rows,p=c.views[n].dates,q=36e5,r=864e5,s=.016,t=!1,u=!1;for(a=0;a<7;a+=1)p[a].events=[];for(b=0;b<7;b+=1)for(d=0;d<24;d+=1)o[d][b].events=[];for(a=0;a<h;a+=1){var v=g[a],w=new Date(v.startTime),x=new Date(v.endTime);if(v.allDay&&!c.disableAllDay){if(x<=l||w>=m)continue;t=!0;var y;y=w<=l?0:Math.floor((w-l)/r);var z;z=x>=m?Math.ceil((m-l)/r):Math.ceil((x-l)/r);var A={event:v,startIndex:y,endIndex:z};e=p[y].events,e?e.push(A):(e=[],e.push(A),p[y].events=e)}else{if(x<=j||w>=k)continue;u=!0;var B,C;w<=j?C=0:(B=w-j-6e4*(w.getTimezoneOffset()-j.getTimezoneOffset()),C=B/q);var D;x>=k?(B=k-j-6e4*(k.getTimezoneOffset()-j.getTimezoneOffset()),D=B/q):(B=x-j-6e4*(x.getTimezoneOffset()-j.getTimezoneOffset()),D=B/q);var E,F=Math.floor(C),G=Math.ceil(D-s),H=F%24,I=Math.floor(F/24),J=24*I,K=0,L=0;1!==f.hourParts&&(K=Math.floor((C-F)*f.hourParts));do{J+=24,J<=G?E=24:(E=G%24,1!==f.hourParts&&(L=Math.floor((G-D)*f.hourParts)));var M={event:v,startIndex:H,endIndex:E,startOffset:K,endOffset:L};e=o[H][I].events,e?e.push(M):(e=[],e.push(M),o[H][I].events=e),H=0,K=0,I+=1}while(J<G)}}if(u)for(b=0;b<7;b+=1){var N=[];for(d=0;d<24;d+=1)o[d][b].events&&(o[d][b].events.sort(i),N=N.concat(o[d][b].events));N.length>0&&f.placeEvents(N)}if(t){var O=[];for(b=0;b<7;b+=1)p[b].events&&(O=O.concat(p[b].events));O.length>0&&f.placeAllDayEvents(O)}},f._getRange=function(a){var b,c,d=a.getFullYear(),e=a.getMonth(),g=a.getDate(),h=a.getDay(),i=h-f.startingDayWeek;return i<0&&(i+=7),b=new Date(d,e,g-i),c=new Date(d,e,g-i+7),{startTime:b,endTime:c}},f.registerSlideChanged(c),f.refreshView()}}}]).directive("dayview",["dateFilter","$ionicSlideBoxDelegate",function(a,b){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/day.html",require:"^calendar",link:function(c,d,e,f){function g(a){for(var b,c=[],d=a.getHours(),e=a.getDate(),f=0;f<24;f+=1)b=new Date(a.getTime()),b.setHours(d+f),b.setDate(e),c.push({time:b});return c}function h(a,b){return a.startOffset-b.startOffset}f.disableSwipe&&b.enableSlide(!1),c.formatHourColumn=f.formatHourColumn,f.mode={step:{days:1}},c.allDayLabel=f.allDayLabel,c.hourParts=f.hourParts,c.allDayEventTemplateUrl=f.dayviewAllDayEventTemplateUrl,c.normalEventTemplateUrl=f.dayviewNormalEventTemplateUrl,c.disableAllDay=f.disableAllDay,c.dayStart=f.dayStart,c.dayEnd=f.dayEnd,c.select=function(a,b){c.timeSelected&&c.timeSelected({selectedTime:a,events:b})},f._onDataLoaded=function(){var a,b,d=f.eventSource,e=d?d.length:0,g=f.range.startTime,i=f.range.endTime,j=new Date(Date.UTC(g.getFullYear(),g.getMonth(),g.getDate())),k=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())),l=c.currentViewIndex,m=c.views[l].rows,n=c.views[l].allDayEvents=[],o=36e5,p=.016,q=!1;for(a=0;a<24;a+=1)m[a].events=[];for(var r=0;r<e;r+=1){var s=d[r],t=new Date(s.startTime),u=new Date(s.endTime);if(s.allDay){if(u<=j||t>=k)continue;n.push({event:s})}else{if(u<=g||t>=i)continue;q=!0;var v,w;t<=g?w=0:(v=t-g-6e4*(t.getTimezoneOffset()-g.getTimezoneOffset()),w=v/o);var x;u>=i?(v=i-g-6e4*(i.getTimezoneOffset()-g.getTimezoneOffset()),x=v/o):(v=u-g-6e4*(u.getTimezoneOffset()-g.getTimezoneOffset()),x=v/o);var y=Math.floor(w),z=Math.ceil(x-p),A=0,B=0;1!==f.hourParts&&(A=Math.floor((w-y)*f.hourParts),B=Math.floor((z-x)*f.hourParts));var C={event:s,startIndex:y,endIndex:z,startOffset:A,endOffset:B};b=m[y].events,b?b.push(C):(b=[],b.push(C),m[y].events=b)}}if(q){var D=[];for(a=0;a<24;a+=1)m[a].events&&(m[a].events.sort(h),D=D.concat(m[a].events));D.length>0&&f.placeEvents(D)}},f._refreshView=function(){f.populateAdjacentViews(c)},f._getTitle=function(){var b=f.range.startTime;return a(b,f.formatDayTitle)},f._getViewData=function(a){return{rows:g(a),allDayEvents:[]}},f._getRange=function(a){var b=a.getFullYear(),c=a.getMonth(),d=a.getDate(),e=new Date(b,c,d),f=new Date(b,c,d+1);return{startTime:e,endTime:f}},f.registerSlideChanged(c),f.refreshView()}}}]);