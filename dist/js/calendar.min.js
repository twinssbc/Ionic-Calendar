angular.module("ui.rCalendar",[]).constant("calendarConfig",{formatDay:"dd",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, Week w",formatMonthTitle:"MMMM yyyy",formatWeekViewDayHeader:"EEE d",formatHourColumn:"ha",allDayLabel:"all day",calendarMode:"month",showEventDetail:!0,startingDayMonth:0,startingDayWeek:0,eventSource:null,noEventsLabel:"No Events",queryMode:"local",step:60}).controller("ui.rCalendar.CalendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","calendarConfig","$timeout","$ionicSlideBoxDelegate",function(a,b,c,d,e,f,g,h,i){"use strict";function j(a,b){var c=a,d=b;return(a.startIndex>b.startIndex||a.startIndex===b.startIndex&&a.startOffset>b.startOffset)&&(c=b,d=a),c.endIndex<=d.startIndex?!1:!(c.endIndex-d.startIndex===1&&c.endOffset+d.startOffset>n.hourParts)}function k(a){var b,c,d,e=a.length,f=0,g=new Array(e);for(b=0;e>b;b+=1){for(d=0;f>d;d+=1)g[d]=!1;for(c=0;b>c;c+=1)j(a[b],a[c])&&(g[a[c].position]=!0);for(d=0;f>d&&g[d];d+=1);f>d?a[b].position=d:a[b].position=f++}}function l(a){var b,c,d,e,f,g,h,i=new Array(24);for(a.sort(function(a,b){return b.position-a.position}),d=0;24>d;d+=1)i[d]={calculated:!1,events:[]};for(f=a.length,d=0;f>d;d+=1)for(b=a[d],c=b.startIndex;c<b.endIndex;)i[c].events.push(b),c+=1;for(d=0;f>d;){if(b=a[d],!b.overlapNumber){var j=b.position+1;b.overlapNumber=j;for(var k=[b];b=k.shift();)for(c=b.startIndex;c<b.endIndex;){if(!i[c].calculated&&(i[c].calculated=!0,i[c].events))for(g=i[c].events.length,e=0;g>e;e+=1)h=i[c].events[e],h.overlapNumber||(h.overlapNumber=j,k.push(h));c+=1}}d+=1}}function m(b,c){var d,e=n.mode.step,f=new Date(b),g=f.getFullYear()+c*(e.years||0),h=f.getMonth()+c*(e.months||0),i=f.getDate()+c*(e.days||0);return f.setFullYear(g,h,i),"month"===a.calendarMode&&(d=new Date(g,h+1,1),d.getTime()<=f.getTime()&&(f=new Date(d-864e5))),f}var n=this,o={$setViewValue:angular.noop};if(angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","formatWeekViewDayHeader","formatHourColumn","allDayLabel","showEventDetail","startingDayMonth","startingDayWeek","eventSource","noEventsLabel","queryMode","step"],function(c,e){n[c]=angular.isDefined(b[c])?7>e?d(b[c])(a.$parent):a.$parent.$eval(b[c]):g[c]}),n.hourParts=1,60!==n.step&&30!==n.step&&15!==n.step)throw new Error("Invalid step parameter: "+n.step);n.hourParts=Math.floor(60/n.step),a.$parent.$watch(b.eventSource,function(a){n.onEventSourceChanged(a)}),a.calendarMode=a.calendarMode||g.calendarMode,angular.isDefined(b.initDate)&&(n.currentCalendarDate=a.$parent.$eval(b.initDate)),n.currentCalendarDate||(n.currentCalendarDate=new Date,b.ngModel&&!a.$parent.$eval(b.ngModel)&&c(b.ngModel).assign(a.$parent,n.currentCalendarDate)),n.init=function(a){o=a,o.$render=function(){n.render()}},n.render=function(){if(o.$modelValue){var a=new Date(o.$modelValue),b=!isNaN(a);b?this.currentCalendarDate=a:e.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),o.$setValidity("date",b)}this.refreshView()},n.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),a.titleChanged&&a.titleChanged({title:n._getTitle()}),this._refreshView(),this.rangeChanged())},n.split=function(a,b){for(var c=[];a.length>0;)c.push(a.splice(0,b));return c},n.onEventSourceChanged=function(a){n.eventSource=a,n._onDataLoaded&&n._onDataLoaded()},n.getAdjacentViewStartTime=function(a){var b=m(n.currentCalendarDate,a);return n._getRange(b).startTime},n.move=function(a){n.direction=a,n.moveOnSelected?n.moveOnSelected=!1:n.currentCalendarDate=m(n.currentCalendarDate,a),o.$setViewValue(n.currentCalendarDate),n.refreshView(),n.direction=0},n.rangeChanged=function(){"local"===n.queryMode?n.eventSource&&n._onDataLoaded&&n._onDataLoaded():"remote"===n.queryMode&&a.rangeChanged&&a.rangeChanged({startTime:this.range.startTime,endTime:this.range.endTime})},n.registerSlideChanged=function(a){a.currentViewIndex=0,a.slideChanged=function(b){h(function(){var c=a.currentViewIndex,d=0;b-c===1||0===b&&2===c?d=1:(c-b===1||2===b&&0===c)&&(d=-1),c=b,a.currentViewIndex=c,n.move(d),a.$digest()},200)}},n.populateAdjacentViews=function(a){var b,c,d,e=a.currentViewIndex,f=this._getViewData;1===n.direction?(b=n.getAdjacentViewStartTime(1),d=(e+1)%3,angular.copy(f(b),a.views[d])):-1===n.direction?(b=n.getAdjacentViewStartTime(-1),d=(e+2)%3,angular.copy(f(b),a.views[d])):a.views?(b=n.range.startTime,angular.copy(f(b),a.views[e]),b=n.getAdjacentViewStartTime(-1),d=(e+2)%3,angular.copy(f(b),a.views[d]),b=n.getAdjacentViewStartTime(1),d=(e+1)%3,angular.copy(f(b),a.views[d])):(c=[],b=n.range.startTime,c.push(f(b)),b=n.getAdjacentViewStartTime(1),c.push(f(b)),b=n.getAdjacentViewStartTime(-1),c.push(f(b)),a.views=c)},n.placeEvents=function(a){k(a),l(a)},n.placeAllDayEvents=function(a){k(a)},n.slideView=function(b){var c=i.$getByHandle(a.calendarMode+"view-slide");c&&(1===b?c.next():-1===b&&c.previous())}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/calendar.html",scope:{calendarMode:"=",rangeChanged:"&",eventSelected:"&",timeSelected:"&",titleChanged:"&"},require:["calendar","?^ngModel"],controller:"ui.rCalendar.CalendarController",link:function(a,b,c,d){var e=d[0],f=d[1];f&&e.init(f),a.$on("changeDate",function(a,b){e.slideView(b)}),a.$on("eventSourceChanged",function(a,b){e.onEventSourceChanged(b)})}}}).directive("monthview",["dateFilter",function(a){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/month.html",require:["^calendar","?^ngModel"],link:function(b,c,d,e){function f(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);b>e;)c[e++]=new Date(d),d.setDate(d.getDate()+1);return c}function g(b,c){return{date:b,label:a(b,c)}}function h(a,c){var d,e=j.currentCalendarDate,f=new Date,g=864e5,h=Math.floor((e.getTime()-a.getTime())/g),i=Math.floor((f.getTime()-a.getTime())/g);for(d=0;42>d;d+=1)c.dates[d].selected=!1;h>=0&&42>h?(c.dates[h].selected=!0,b.selectedDate=c.dates[h]):b.selectedDate={events:[]},i>=0&&42>i&&(c.dates[i].current=!0)}function i(a,b){return a.allDay?1:b.allDay?-1:a.startTime.getTime()-b.startTime.getTime()}var j=e[0],k=e[1];b.showEventDetail=j.showEventDetail,b.formatDayHeader=j.formatDayHeader,j.mode={step:{months:1}},b.noEventsLabel=j.noEventsLabel,b.select=function(a){var c,d,e=b.views;if(e){c=e[b.currentViewIndex].dates;var f=j.currentCalendarDate,g=f.getMonth(),h=f.getFullYear(),i=a.getMonth(),l=a.getFullYear(),m=0;if(h===l?g!==i&&(m=i>g?1:-1):m=l>h?1:-1,j.currentCalendarDate=a,0===m){j.currentCalendarDate=a,k&&k.$setViewValue(a);var n=j.range.startTime,o=864e5,p=Math.floor((a.getTime()-n.getTime())/o);for(d=0;42>d;d+=1)c[d].selected=!1;p>=0&&42>p&&(c[p].selected=!0,b.selectedDate=c[p])}else j.moveOnSelected=!0,j.slideView(m);b.timeSelected&&b.timeSelected({selectedTime:a})}},b.getHighlightClass=function(a){var b="";return a.selected?b="monthview-selected":a.current?b="monthview-current":a.hasEvent&&(b=a.secondary?"monthview-secondary-with-event":"monthview-primary-with-event"),a.secondary&&(b?b+=" text-muted":b="text-muted"),b},j._getTitle=function(){var b=j.range.startTime,c=b.getDate(),d=(b.getMonth()+(1!==c?1:0))%12,e=b.getFullYear()+(1!==c&&0===d?1:0),f=new Date(e,d,1);return a(f,j.formatMonthTitle)},j._getViewData=function(a){for(var b=a,c=b.getDate(),d=(b.getMonth()+(1!==c?1:0))%12,e=f(b,42),h=0;42>h;h++)e[h]=angular.extend(g(e[h],j.formatDay),{secondary:e[h].getMonth()!==d});return{dates:e}},j._refreshView=function(){j.populateAdjacentViews(b),h(j.range.startTime,b.views[b.currentViewIndex])},j._onDataLoaded=function(){for(var a=j.eventSource,c=a?a.length:0,d=j.range.startTime,e=j.range.endTime,f=-(new Date).getTimezoneOffset(),g=new Date(d.getTime()+60*f*1e3),h=new Date(e.getTime()+60*f*1e3),k=b.currentViewIndex,l=b.views[k].dates,m=864e5,n=.001,o=0;42>o;o+=1)l[o].hasEvent&&(l[o].hasEvent=!1,l[o].events=[]);for(var p=0;c>p;p+=1){var q,r,s=a[p],t=new Date(s.startTime),u=new Date(s.endTime);if(s.allDay){if(g>=u||t>=h)continue;q=g,r=h}else{if(d>=u||t>=e)continue;q=d,r=e}var v;v=q>=t?0:(t-q)/m;var w;w=u>=r?(r-q)/m:(u-q)/m;for(var x,y=Math.floor(v);w-n>y;)l[y].hasEvent=!0,x=l[y].events,x?x.push(s):(x=[],x.push(s),l[y].events=x),y+=1}for(o=0;42>o;o+=1)l[o].hasEvent&&l[o].events.sort(i);var z=!1;for(o=0;42>o;o+=1){if(l[o].selected){b.selectedDate=l[o],z=!0;break}if(z)break}},j._getRange=function(a){var b,c=a.getFullYear(),d=a.getMonth(),e=new Date(c,d,1),f=j.startingDayMonth-e.getDay(),g=f>0?7-f:-f,h=new Date(e);return g>0&&h.setDate(-g+1),b=new Date(h),b.setDate(b.getDate()+42),{startTime:h,endTime:b}},j.registerSlideChanged(b),j.refreshView()}}}]).directive("weekview",["dateFilter",function(a){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/week.html",require:"^calendar",link:function(b,c,d,e){function f(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);b>e;)c[e++]={date:new Date(d)},d.setDate(d.getDate()+1);return c}function g(a){for(var b,c,d=[],e=a.getHours(),f=a.getDate(),g=0;24>g;g+=1){b=[];for(var h=0;7>h;h+=1)c=new Date(a.getTime()),c.setHours(e+g),c.setDate(f+h),b.push({time:c});d.push(b)}return d}function h(a,b){return a.startOffset-b.startOffset}function i(a){var b=new Date(a);b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1}b.formatWeekViewDayHeader=e.formatWeekViewDayHeader,b.formatHourColumn=e.formatHourColumn,e.mode={step:{days:7}},b.allDayLabel=e.allDayLabel,b.hourParts=e.hourParts,e._getTitle=function(){var b,c,d=e.range.startTime,f="w";return b=e.formatWeekTitle.indexOf(f),c=a(d,e.formatWeekTitle),-1!==b&&(c=c.replace(f,i(d))),c},b.select=function(a){b.timeSelected&&b.timeSelected({selectedTime:a})},e._getViewData=function(a){return{rows:g(a),dates:f(a,7)}},e._refreshView=function(){e.populateAdjacentViews(b)},e._onDataLoaded=function(){var a,c,d,f,g=e.eventSource,i=g?g.length:0,j=e.range.startTime,k=e.range.endTime,l=-(new Date).getTimezoneOffset(),m=new Date(j.getTime()+6e4*l),n=new Date(k.getTime()+6e4*l),o=b.currentViewIndex,p=b.views[o].rows,q=b.views[o].dates,r=36e5,s=864e5,t=.016,u=!1,v=!1;for(a=0;7>a;a+=1)q[a].events=[];for(c=0;7>c;c+=1)for(d=0;24>d;d+=1)p[d][c].events=[];for(a=0;i>a;a+=1){var w=g[a],x=new Date(w.startTime),y=new Date(w.endTime);if(w.allDay){if(m>=y||x>=n)continue;u=!0;var z;z=m>=x?0:Math.floor((x-m)/s);var A;A=y>=n?Math.ceil((n-m)/s):Math.ceil((y-m)/s);var B={event:w,startIndex:z,endIndex:A};f=q[z].events,f?f.push(B):(f=[],f.push(B),q[z].events=f)}else{if(j>=y||x>=k)continue;v=!0;var C;C=j>=x?0:(x-j)/r;var D;D=y>=k?(k-j)/r:(y-j)/r;var E,F=Math.floor(C),G=Math.ceil(D-t),H=F%24,I=Math.floor(F/24),J=24*I,K=0,L=0;1!==e.hourParts&&(K=Math.floor((C-F)*e.hourParts));do{J+=24,G>=J?E=24:(E=G%24,1!==e.hourParts&&(L=Math.floor((G-D)*e.hourParts)));var M={event:w,startIndex:H,endIndex:E,startOffset:K,endOffset:L};f=p[H][I].events,f?f.push(M):(f=[],f.push(M),p[H][I].events=f),H=0,K=0,I+=1}while(G>J)}}if(v)for(c=0;7>c;c+=1){var N=[];for(d=0;24>d;d+=1)p[d][c].events&&(p[d][c].events.sort(h),N=N.concat(p[d][c].events));N.length>0&&e.placeEvents(N)}if(u){var O=[];for(c=0;7>c;c+=1)q[c].events&&(O=O.concat(q[c].events));O.length>0&&e.placeAllDayEvents(O)}},e._getRange=function(a){var b=a.getFullYear(),c=a.getMonth(),d=a.getDate(),f=a.getDay(),g=new Date(b,c,d-f+e.startingDayWeek),h=new Date(b,c,d-f+e.startingDayWeek+7);return{startTime:g,endTime:h}},e.registerSlideChanged(b),e.refreshView()}}}]).directive("dayview",["dateFilter",function(a){"use strict";return{restrict:"EA",replace:!0,templateUrl:"templates/rcalendar/day.html",require:"^calendar",link:function(b,c,d,e){function f(a){for(var b,c=[],d=a.getHours(),e=a.getDate(),f=0;24>f;f+=1)b=new Date(a.getTime()),b.setHours(d+f),b.setDate(e),c.push({time:b});return c}function g(a,b){return a.startOffset-b.startOffset}b.formatHourColumn=e.formatHourColumn,e.mode={step:{days:1}},b.allDayLabel=e.allDayLabel,b.hourParts=e.hourParts,b.select=function(a){b.timeSelected&&b.timeSelected({selectedTime:a})},e._onDataLoaded=function(){var a,c,d=e.eventSource,f=d?d.length:0,h=e.range.startTime,i=e.range.endTime,j=-(new Date).getTimezoneOffset(),k=new Date(h.getTime()+60*j*1e3),l=new Date(i.getTime()+60*j*1e3),m=b.currentViewIndex,n=b.views[m].rows,o=b.views[m].allDayEvents=[],p=36e5,q=.016,r=!1;for(a=0;24>a;a+=1)n[a].events=[];for(var s=0;f>s;s+=1){var t=d[s],u=new Date(t.startTime),v=new Date(t.endTime);if(t.allDay){if(k>=v||u>=l)continue;o.push({event:t})}else{if(h>=v||u>=i)continue;r=!0;var w;w=h>=u?0:(u-h)/p;var x;x=v>=i?(i-h)/p:(v-h)/p;var y=Math.floor(w),z=Math.ceil(x-q),A=0,B=0;1!==e.hourParts&&(A=Math.floor((w-y)*e.hourParts),B=Math.floor((z-x)*e.hourParts));var C={event:t,startIndex:y,endIndex:z,startOffset:A,endOffset:B};c=n[y].events,c?c.push(C):(c=[],c.push(C),n[y].events=c)}}if(r){var D=[];for(a=0;24>a;a+=1)n[a].events&&(n[a].events.sort(g),D=D.concat(n[a].events));D.length>0&&e.placeEvents(D)}},e._refreshView=function(){e.populateAdjacentViews(b)},e._getTitle=function(){var b=e.range.startTime;return a(b,e.formatDayTitle)},e._getViewData=function(a){return{rows:f(a),allDayEvents:[]}},e._getRange=function(a){var b=a.getFullYear(),c=a.getMonth(),d=a.getDate(),e=new Date(b,c,d),f=new Date(b,c,d+1);return{startTime:e,endTime:f}},e.registerSlideChanged(b),e.refreshView()}}}]);